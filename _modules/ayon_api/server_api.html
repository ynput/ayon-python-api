
	

<!DOCTYPE html>
<html class="writer-html5 " lang="en" >
<head>
	<meta charset="utf-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
		<title>ayon_api.server_api &mdash; ayon-python-api 1.2.10 documentation</title>
	
	
	
	<link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
	<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
	<link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
	<link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

	
	
		<link rel="shortcut icon" href="../../_static/favicon.ico"/>
	
	
	
		<link rel="canonical" href="https://github.com/ynput/ayon-python-api_modules/ayon_api/server_api.html"/>
	

	
	<!--[if lt IE 9]>
		<script src="../../_static/js/html5shiv.min.js"></script>
	<![endif]-->
	
		
			<script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
				<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
				<script src="../../_static/jquery.js"></script>
				<script src="../../_static/underscore.js"></script>
				<script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
				<script src="../../_static/doctools.js"></script>
				<script src="../../_static/sphinx_highlight.js"></script>
		
		<script type="text/javascript" src="../../_static/js/theme.js"></script>

		
		<link rel="index" title="Index" href="../../genindex.html" />
		<link rel="search" title="Search" href="../../search.html" /> 
</head>
<body class="wy-body-for-nav">


	 
	<div class="wy-grid-for-nav">
		
		<nav data-toggle="wy-nav-shift" class="wy-nav-side">
			<div class="wy-side-scroll">
				<div class="wy-side-nav-search">
					
						<div class="brand">
							<a href="../../index.html">
							
								<img src="../../_static/AYON_blackG_dot.svg" class="logo" alt="Logo"/>
							
							</a>
						</div>
						
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
					
				</div>
				
				<div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
					
						
						
							
						
						
							<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ayon_api</a></li>
</ul>

						
					
				</div>
				
			</div>
		</nav>

		<section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

			
			<nav class="wy-nav-top" aria-label="top navigation">
			
				<i data-toggle="wy-nav-top" class="fa fa-bars"></i>
				<a href="../../index.html">
					
						<img src="../../_static/AYON_blackG_dot.svg" class="logo" alt="Logo"/>
					
				</a>
			
			</nav>


			<div class="wy-nav-content">
				
				<div class="rst-content">
				
					<div role="navigation" aria-label="breadcrumbs navigation">

	<ul class="wy-breadcrumbs">
		
			
				<li><a href="../../index.html">ayon-python-api</a> ⁄&nbsp;</li>
				
					<li><a href="../index.html">Module code</a> ⁄&nbsp;</li>
				
				<li><a href="">ayon_api.server_api</a></li>
			
		
		
			<li class="wy-breadcrumbs-aside">
			
				<a href="https://github.com/ynput/ayon-python-api" class="fa fa-github-alt"></a>
			
			</li>
		
	</ul>

</div>
					<div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
					 <div itemprop="articleBody">
						
  <h1>Source code for ayon_api.server_api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Server API.</span>

<span class="sd">Provides access to server API.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SERVER_RETRIES_ENV_KEY</span><span class="p">,</span>
    <span class="n">DEFAULT_FOLDER_TYPE_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_TASK_TYPE_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_PROJECT_STATUSES_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_PROJECT_TAGS_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_PRODUCT_TYPE_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_PROJECT_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_FOLDER_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_TASK_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_PRODUCT_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_VERSION_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_REPRESENTATION_FIELDS</span><span class="p">,</span>
    <span class="n">REPRESENTATION_FILES_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_WORKFILE_INFO_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_EVENT_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_ACTIVITY_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_USER_FIELDS</span><span class="p">,</span>
    <span class="n">DEFAULT_ENTITY_LIST_FIELDS</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.graphql</span> <span class="kn">import</span> <span class="n">INTROSPECTION_QUERY</span>
<span class="kn">from</span> <span class="nn">.graphql_queries</span> <span class="kn">import</span> <span class="n">users_graphql_query</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FailedOperations</span><span class="p">,</span>
    <span class="n">UnauthorizedError</span><span class="p">,</span>
    <span class="n">AuthenticationError</span><span class="p">,</span>
    <span class="n">ServerNotReached</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RequestType</span><span class="p">,</span>
    <span class="n">RequestTypes</span><span class="p">,</span>
    <span class="n">RestApiResponse</span><span class="p">,</span>
    <span class="n">prepare_query_string</span><span class="p">,</span>
    <span class="n">logout_from_server</span><span class="p">,</span>
    <span class="n">create_entity_id</span><span class="p">,</span>
    <span class="n">entity_data_json_default</span><span class="p">,</span>
    <span class="n">failed_json_default</span><span class="p">,</span>
    <span class="n">TransferProgress</span><span class="p">,</span>
    <span class="n">get_default_timeout</span><span class="p">,</span>
    <span class="n">get_default_settings_variant</span><span class="p">,</span>
    <span class="n">get_default_site_id</span><span class="p">,</span>
    <span class="n">NOT_SET</span><span class="p">,</span>
    <span class="n">get_media_mime_type</span><span class="p">,</span>
    <span class="n">get_machine_name</span><span class="p">,</span>
    <span class="n">fill_own_attribs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._api_helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">InstallersAPI</span><span class="p">,</span>
    <span class="n">DependencyPackagesAPI</span><span class="p">,</span>
    <span class="n">SecretsAPI</span><span class="p">,</span>
    <span class="n">BundlesAddonsAPI</span><span class="p">,</span>
    <span class="n">EventsAPI</span><span class="p">,</span>
    <span class="n">AttributesAPI</span><span class="p">,</span>
    <span class="n">ProjectsAPI</span><span class="p">,</span>
    <span class="n">FoldersAPI</span><span class="p">,</span>
    <span class="n">TasksAPI</span><span class="p">,</span>
    <span class="n">ProductsAPI</span><span class="p">,</span>
    <span class="n">VersionsAPI</span><span class="p">,</span>
    <span class="n">RepresentationsAPI</span><span class="p">,</span>
    <span class="n">WorkfilesAPI</span><span class="p">,</span>
    <span class="n">ThumbnailsAPI</span><span class="p">,</span>
    <span class="n">ActivitiesAPI</span><span class="p">,</span>
    <span class="n">ActionsAPI</span><span class="p">,</span>
    <span class="n">LinksAPI</span><span class="p">,</span>
    <span class="n">ListsAPI</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.typing</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ServerVersion</span><span class="p">,</span>
        <span class="n">AnyEntityDict</span><span class="p">,</span>
        <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">BackgroundOperationTask</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">VERSION_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;(?P&lt;major&gt;0|[1-9]\d*)&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;\.(?P&lt;minor&gt;0|[1-9]\d*)&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;\.(?P&lt;patch&gt;0|[1-9]\d*)&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;(?:-(?P&lt;prerelease&gt;[a-zA-Z\d\-.]*))?&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;(?:\+(?P&lt;buildmetadata&gt;[a-zA-Z\d\-.]*))?&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="GraphQlResponse"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.GraphQlResponse">[docs]</a><span class="k">class</span> <span class="nc">GraphQlResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GraphQl response.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> errors=</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>


<span class="k">class</span> <span class="nc">_AsUserStack</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle stack of users used over server api connection in service mode.</span>

<span class="sd">    ServerAPI can behave as other users if it is using special API key.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; stack = _AsUserStack()</span>
<span class="sd">        &gt;&gt;&gt; stack.set_default_username(&quot;DefaultName&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(stack.username)</span>
<span class="sd">        DefaultName</span>
<span class="sd">        &gt;&gt;&gt; with stack.as_user(&quot;Other1&quot;):</span>
<span class="sd">        ...     print(stack.username)</span>
<span class="sd">        ...     with stack.as_user(&quot;Other2&quot;):</span>
<span class="sd">        ...         print(stack.username)</span>
<span class="sd">        ...     print(stack.username)</span>
<span class="sd">        ...     stack.clear()</span>
<span class="sd">        ...     print(stack.username)</span>
<span class="sd">        Other1</span>
<span class="sd">        Other2</span>
<span class="sd">        Other1</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; print(stack.username)</span>
<span class="sd">        None</span>
<span class="sd">        &gt;&gt;&gt; stack.set_default_username(&quot;DefaultName&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(stack.username)</span>
<span class="sd">        DefaultName</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_users_by_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_user</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_users_by_id</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_user</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Use &#39;_user_ids&#39; for boolean check to have ability &quot;unset&quot;</span>
        <span class="c1">#   default user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_user</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_user</span>

    <span class="k">def</span> <span class="nf">get_default_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_user</span>

    <span class="k">def</span> <span class="nf">set_default_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_user</span> <span class="o">=</span> <span class="n">username</span>

    <span class="n">default_username</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_default_username</span><span class="p">,</span> <span class="n">set_default_username</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">as_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_user</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_users_by_id</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_users_by_id</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># First check if is the user id the last one</span>
            <span class="n">was_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_id</span>
            <span class="c1"># Remove id from variables</span>
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">was_last</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">new_last_user</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">:</span>
                <span class="n">new_last_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_users_by_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_user</span> <span class="o">=</span> <span class="n">new_last_user</span>


<div class="viewcode-block" id="ServerAPI"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI">[docs]</a><span class="k">class</span> <span class="nc">ServerAPI</span><span class="p">(</span>
    <span class="n">InstallersAPI</span><span class="p">,</span>
    <span class="n">DependencyPackagesAPI</span><span class="p">,</span>
    <span class="n">SecretsAPI</span><span class="p">,</span>
    <span class="n">BundlesAddonsAPI</span><span class="p">,</span>
    <span class="n">EventsAPI</span><span class="p">,</span>
    <span class="n">AttributesAPI</span><span class="p">,</span>
    <span class="n">ProjectsAPI</span><span class="p">,</span>
    <span class="n">FoldersAPI</span><span class="p">,</span>
    <span class="n">TasksAPI</span><span class="p">,</span>
    <span class="n">ProductsAPI</span><span class="p">,</span>
    <span class="n">VersionsAPI</span><span class="p">,</span>
    <span class="n">RepresentationsAPI</span><span class="p">,</span>
    <span class="n">WorkfilesAPI</span><span class="p">,</span>
    <span class="n">ThumbnailsAPI</span><span class="p">,</span>
    <span class="n">ActivitiesAPI</span><span class="p">,</span>
    <span class="n">ActionsAPI</span><span class="p">,</span>
    <span class="n">LinksAPI</span><span class="p">,</span>
    <span class="n">ListsAPI</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base handler of connection to server.</span>

<span class="sd">    Requires url to server which is used as base for api and graphql calls.</span>

<span class="sd">    Login cause that a session is used</span>

<span class="sd">    Args:</span>
<span class="sd">        base_url (str): Example: http://localhost:5000</span>
<span class="sd">        token (Optional[str]): Access token (api key) to server.</span>
<span class="sd">        site_id (Optional[str]): Unique name of site. Should be the same when</span>
<span class="sd">            connection is created from the same machine under same user.</span>
<span class="sd">        client_version (Optional[str]): Version of client application (used in</span>
<span class="sd">            desktop client application).</span>
<span class="sd">        default_settings_variant (Optional[Literal[&quot;production&quot;, &quot;staging&quot;]]):</span>
<span class="sd">            Settings variant used by default if a method for settings won&#39;t</span>
<span class="sd">            get any (by default is &#39;production&#39;).</span>
<span class="sd">        sender_type (Optional[str]): Sender type of requests. Used in server</span>
<span class="sd">            logs and propagated into events.</span>
<span class="sd">        sender (Optional[str]): Sender of requests, more specific than</span>
<span class="sd">            sender type (e.g. machine name). Used in server logs and</span>
<span class="sd">            propagated into events.</span>
<span class="sd">        ssl_verify (Optional[Union[bool, str]]): Verify SSL certificate</span>
<span class="sd">            Looks for env variable value ``AYON_CA_FILE`` by default. If not</span>
<span class="sd">            available then &#39;True&#39; is used.</span>
<span class="sd">        cert (Optional[str]): Path to certificate file. Looks for env</span>
<span class="sd">            variable value ``AYON_CERT_FILE`` by default.</span>
<span class="sd">        create_session (Optional[bool]): Create session for connection if</span>
<span class="sd">            token is available. Default is True.</span>
<span class="sd">        timeout (Optional[float]): Timeout for requests.</span>
<span class="sd">        max_retries (Optional[int]): Number of retries for requests.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_default_max_retries</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1"># 1 MB chunk by default</span>
    <span class="c1"># TODO find out if these are reasonable default value</span>
    <span class="n">default_download_chunk_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">default_upload_chunk_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">site_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_SET</span><span class="p">,</span>
        <span class="n">client_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_settings_variant</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sender_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sender</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl_verify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_session</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid server URL </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rest_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/api&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/graphql&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="c1"># Allow to have &#39;site_id&#39; to &#39;None&#39;</span>
        <span class="k">if</span> <span class="n">site_id</span> <span class="ow">is</span> <span class="n">NOT_SET</span><span class="p">:</span>
            <span class="n">site_id</span> <span class="o">=</span> <span class="n">get_default_site_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_settings_variant</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">default_settings_variant</span>
            <span class="ow">or</span> <span class="n">get_default_settings_variant</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">sender_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set timeout and max retries based on passed values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_max_retries</span><span class="p">(</span><span class="n">max_retries</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ssl_verify</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Custom AYON env variable for CA file or &#39;True&#39;</span>
            <span class="c1"># - that should cover most default behaviors in &#39;requests&#39;</span>
            <span class="c1">#   with &#39;certifi&#39;</span>
            <span class="n">ssl_verify</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AYON_CA_FILE&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">cert</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cert</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AYON_CERT_FILE&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span> <span class="o">=</span> <span class="n">ssl_verify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cert</span> <span class="o">=</span> <span class="n">cert</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_available</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_version_tuple</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_allows_traits_in_representations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_base_type_supported</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_base_functions_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">post</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">put</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">patch</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Attributes cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entity_type_attributes_cache</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span> <span class="o">=</span> <span class="n">_AsUserStack</span><span class="p">()</span>

        <span class="c1"># Create session</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="ow">and</span> <span class="n">create_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_server_availability</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_session</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span>

<div class="viewcode-block" id="ServerAPI.get_base_url"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_base_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span></div>

<div class="viewcode-block" id="ServerAPI.get_rest_url"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_rest_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_rest_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rest_url</span></div>

    <span class="n">base_url</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_base_url</span><span class="p">)</span>
    <span class="n">rest_url</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_rest_url</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_ssl_verify"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_ssl_verify">[docs]</a>    <span class="k">def</span> <span class="nf">get_ssl_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable ssl verification.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Current state of ssl verification.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span></div>

<div class="viewcode-block" id="ServerAPI.set_ssl_verify"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_ssl_verify">[docs]</a>    <span class="k">def</span> <span class="nf">set_ssl_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_verify</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change ssl verification state.</span>

<span class="sd">        Args:</span>
<span class="sd">            ssl_verify (Union[bool, str, None]): Enabled/disable</span>
<span class="sd">                ssl verification, can be a path to file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span> <span class="o">==</span> <span class="n">ssl_verify</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span> <span class="o">=</span> <span class="n">ssl_verify</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">ssl_verify</span></div>

<div class="viewcode-block" id="ServerAPI.get_cert"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_cert">[docs]</a>    <span class="k">def</span> <span class="nf">get_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current cert file used for connection to server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]: Path to cert file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cert</span></div>

<div class="viewcode-block" id="ServerAPI.set_cert"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_cert">[docs]</a>    <span class="k">def</span> <span class="nf">set_cert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cert</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change cert file used for connection to server.</span>

<span class="sd">        Args:</span>
<span class="sd">            cert (Union[str, None]): Path to cert file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cert</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cert</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cert</span> <span class="o">=</span> <span class="n">cert</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">cert</span></div>

    <span class="n">ssl_verify</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_ssl_verify</span><span class="p">,</span> <span class="n">set_ssl_verify</span><span class="p">)</span>
    <span class="n">cert</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_cert</span><span class="p">,</span> <span class="n">set_cert</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_default_timeout"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_default_timeout">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_timeout</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default value for requests timeout.</span>

<span class="sd">        Utils function &#39;get_default_timeout&#39; is used by default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Timeout value in seconds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_default_timeout</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.get_default_max_retries"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_default_max_retries">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_default_max_retries</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default value for requests max retries.</span>

<span class="sd">        First looks for environment variable SERVER_RETRIES_ENV_KEY, which</span>
<span class="sd">        can affect max retries value. If not available then use class</span>
<span class="sd">        attribute &#39;_default_max_retries&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Max retries value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SERVER_RETRIES_ENV_KEY</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_max_retries</span></div>

<div class="viewcode-block" id="ServerAPI.get_timeout"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">get_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current value for requests timeout.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Timeout value in seconds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span></div>

<div class="viewcode-block" id="ServerAPI.set_timeout"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">set_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change timeout value for requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout (Optional[float]): Timeout value in seconds.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_timeout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.get_max_retries"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_max_retries">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_retries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current value for requests max retries.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Max retries value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_retries</span></div>

<div class="viewcode-block" id="ServerAPI.set_max_retries"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_max_retries">[docs]</a>    <span class="k">def</span> <span class="nf">set_max_retries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change max retries value for requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_retries (Optional[int]): Max retries value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_retries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_max_retries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_retries</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_retries</span><span class="p">)</span></div>

    <span class="n">timeout</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_timeout</span><span class="p">,</span> <span class="n">set_timeout</span><span class="p">)</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_max_retries</span><span class="p">,</span> <span class="n">set_max_retries</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">access_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Access token used for authorization to server.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Token string or None if not authorized yet.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span>

<div class="viewcode-block" id="ServerAPI.is_service_user"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.is_service_user">[docs]</a>    <span class="k">def</span> <span class="nf">is_service_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if connection is using service API key.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Used api key belongs to service user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_valid_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User is not logged in.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.get_site_id"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_site_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Site id used for connection.</span>

<span class="sd">        Site id tells server from which machine/site is connection created and</span>
<span class="sd">        is used for default site overrides when settings are received.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Site id value or None if not filled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span></div>

<div class="viewcode-block" id="ServerAPI.set_site_id"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_site_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_site_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change site id of connection.</span>

<span class="sd">        Behave as specific site for server. It affects default behavior of</span>
<span class="sd">        settings getter methods.</span>

<span class="sd">        Args:</span>
<span class="sd">            site_id (Optional[str]): Site id value, or &#39;None&#39; to unset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span> <span class="o">==</span> <span class="n">site_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span> <span class="o">=</span> <span class="n">site_id</span>
        <span class="c1"># Recreate session on machine id change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

    <span class="n">site_id</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_site_id</span><span class="p">,</span> <span class="n">set_site_id</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_client_version"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_client_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_client_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Version of client used to connect to server.</span>

<span class="sd">        Client version is AYON client build desktop application.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Client version string used in connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span></div>

<div class="viewcode-block" id="ServerAPI.set_client_version"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_client_version">[docs]</a>    <span class="k">def</span> <span class="nf">set_client_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set version of client used to connect to server.</span>

<span class="sd">        Client version is AYON client build desktop application.</span>

<span class="sd">        Args:</span>
<span class="sd">            client_version (Optional[str]): Client version string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span> <span class="o">==</span> <span class="n">client_version</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span> <span class="o">=</span> <span class="n">client_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

    <span class="n">client_version</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_client_version</span><span class="p">,</span> <span class="n">set_client_version</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_default_settings_variant"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_default_settings_variant">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_settings_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default variant used for settings.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]: name of variant or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_settings_variant</span></div>

<div class="viewcode-block" id="ServerAPI.set_default_settings_variant"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_default_settings_variant">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_settings_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change default variant for addon settings.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is recommended to set only &#39;production&#39; or &#39;staging&#39; variants</span>
<span class="sd">                as default variant.</span>

<span class="sd">        Args:</span>
<span class="sd">            variant (str): Settings variant name. It is possible to use</span>
<span class="sd">                &#39;production&#39;, &#39;staging&#39; or name of dev bundle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_settings_variant</span> <span class="o">=</span> <span class="n">variant</span></div>

    <span class="n">default_settings_variant</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">get_default_settings_variant</span><span class="p">,</span>
        <span class="n">set_default_settings_variant</span>
    <span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_sender"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_sender">[docs]</a>    <span class="k">def</span> <span class="nf">get_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sender used to send requests.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]: Sender name or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span></div>

<div class="viewcode-block" id="ServerAPI.set_sender"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_sender">[docs]</a>    <span class="k">def</span> <span class="nf">set_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change sender used for requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            sender (Optional[str]): Sender name or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sender</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span> <span class="o">=</span> <span class="n">sender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

    <span class="n">sender</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_sender</span><span class="p">,</span> <span class="n">set_sender</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_sender_type"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_sender_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_sender_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sender type used to send requests.</span>

<span class="sd">        Sender type is supported since AYON server 1.5.5 .</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: Sender type or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span></div>

<div class="viewcode-block" id="ServerAPI.set_sender_type"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_sender_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_sender_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change sender type used for requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            sender_type (Optional[str]): Sender type or None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sender_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span> <span class="o">=</span> <span class="n">sender_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

    <span class="n">sender_type</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_sender_type</span><span class="p">,</span> <span class="n">set_sender_type</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_default_service_username"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_default_service_username">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_service_username</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default username used for callbacks when used with service API key.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[str, None]: Username if any was filled.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">get_default_username</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.set_default_service_username"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_default_service_username">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_service_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Service API will work as other user.</span>

<span class="sd">        Service API keys can work as other user. It can be temporary using</span>
<span class="sd">        context manager &#39;as_user&#39; or it is possible to set default username if</span>
<span class="sd">        &#39;as_user&#39; context manager is not entered.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (Optional[str]): Username to work as when service.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: When connection is not yet authenticated or api key</span>
<span class="sd">                is not service token.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">get_default_username</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_username</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_valid_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Authentication of connection did not happen yet.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t set service username. API key is not a service token.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">set_default_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.as_username"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.as_username">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">as_username</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ignore_service_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Service API will temporarily work as other user.</span>

<span class="sd">        This method can be used only if service API key is logged in.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (Optional[str]): Username to work as when service.</span>
<span class="sd">            ignore_service_error (Optional[bool]): Ignore error when service</span>
<span class="sd">                API key is not used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: When connection is not yet authenticated or api key</span>
<span class="sd">                is not service token.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_valid_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Authentication of connection did not happen yet.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_service_error</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t set service username. API key is not a service token.&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">as_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="k">as</span> <span class="n">o</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span>
                <span class="k">yield</span> <span class="n">o</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_headers</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_server_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_available</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">,</span>
                <span class="n">cert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cert</span><span class="p">,</span>
                <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_available</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_available</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_valid_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span>

<div class="viewcode-block" id="ServerAPI.validate_server_availability"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.validate_server_availability">[docs]</a>    <span class="k">def</span> <span class="nf">validate_server_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_server_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ServerNotReached</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Server </span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> can&#39;t be reached&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.validate_token"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.validate_token">[docs]</a>    <span class="k">def</span> <span class="nf">validate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># TODO add other possible validations</span>
            <span class="c1"># - existence of &#39;user&#39; key in info</span>
            <span class="c1"># - validate that &#39;site_id&#39; is in &#39;sites&#39; in info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">UnauthorizedError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span></div>

<div class="viewcode-block" id="ServerAPI.set_token"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.set_token">[docs]</a>    <span class="k">def</span> <span class="nf">set_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.reset_token"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.reset_token">[docs]</a>    <span class="k">def</span> <span class="nf">reset_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.create_session"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.create_session">[docs]</a>    <span class="k">def</span> <span class="nf">create_session</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ignore_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a connection session.</span>

<span class="sd">        Session helps to keep connection with server without</span>
<span class="sd">        need to reconnect on each call.</span>

<span class="sd">        Args:</span>
<span class="sd">            ignore_existing (bool): If session already exists,</span>
<span class="sd">                ignore creation.</span>
<span class="sd">            force (bool): If session already exists, close it and</span>
<span class="sd">                create new.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_existing</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Session is already created.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Validate token before session creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_token</span><span class="p">()</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cert</span>
        <span class="n">session</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssl_verify</span>
        <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">post</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">put</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">put</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">patch</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">patch</span><span class="p">,</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span></div>

<div class="viewcode-block" id="ServerAPI.close_session"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.close_session">[docs]</a>    <span class="k">def</span> <span class="nf">close_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_update_session_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Header keys that may change over time</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;X-as-user&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">username</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;x-ayon-version&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;x-ayon-site-id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;x-sender-type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;x-sender&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="ServerAPI.get_info"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get information about current used api key.</span>

<span class="sd">        By default, the &#39;info&#39; contains only &#39;uptime&#39; and &#39;version&#39;. With</span>
<span class="sd">        logged user info also contains information about user and machines on</span>
<span class="sd">        which was logged in.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Use this method for validation of token instead of &#39;get_user&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: Information from server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="ServerAPI.get_server_version"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_server_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get server version.</span>

<span class="sd">        Version should match semantic version (https://semver.org/).</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Server version.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">()[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_version</span></div>

<div class="viewcode-block" id="ServerAPI.get_server_version_tuple"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_server_version_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_version_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ServerVersion</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get server version as tuple.</span>

<span class="sd">        Version should match semantic version (https://semver.org/).</span>

<span class="sd">        This function only returns first three numbers of version.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ServerVersion: Server version.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_version_tuple</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">re_match</span> <span class="o">=</span> <span class="n">VERSION_REGEX</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_server_version</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_version_tuple</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;major&quot;</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;minor&quot;</span><span class="p">)),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;patch&quot;</span><span class="p">)),</span>
                <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;prerelease&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">re_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;buildmetadata&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_version_tuple</span></div>

    <span class="n">server_version</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_server_version</span><span class="p">)</span>
    <span class="n">server_version_tuple</span><span class="p">:</span> <span class="n">ServerVersion</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">get_server_version_tuple</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">graphql_allows_traits_in_representations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check server support for representation traits.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_allows_traits_in_representations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_allows_traits_in_representations</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_allows_traits_in_representations</span>

<div class="viewcode-block" id="ServerAPI.is_product_base_type_supported"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.is_product_base_type_supported">[docs]</a>    <span class="k">def</span> <span class="nf">is_product_base_type_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Product base types are available on server.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product_base_type_supported</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_product_base_type_supported</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product_base_type_supported</span></div>

    <span class="k">def</span> <span class="nf">_get_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users/me&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users/me&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;users/me&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ServerAPI.get_users"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_users">[docs]</a>    <span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">usernames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">emails</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get Users.</span>

<span class="sd">        Only administrators and managers can fetch all users. For other users</span>
<span class="sd">            it is required to pass in &#39;project_name&#39; filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (Optional[str]): Project name.</span>
<span class="sd">            usernames (Optional[Iterable[str]]): Filter by usernames.</span>
<span class="sd">            emails (Optional[Iterable[str]]): Filter by emails.</span>
<span class="sd">            fields (Optional[Iterable[str]]): Fields to be queried</span>
<span class="sd">                for users.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Generator[dict[str, Any]]: Queried users.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">usernames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">usernames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">usernames</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">usernames</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;userNames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">usernames</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">emails</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">emails</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
            <span class="n">emails_filter_available</span> <span class="o">=</span> <span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">patch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">emails_filter_available</span><span class="p">:</span>
                <span class="n">server_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_version</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Filtering by emails is not supported by&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; server version </span><span class="si">{</span><span class="n">server_version</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;emails&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">project_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;projectName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_fields_for_type</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">users_graphql_query</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">filter_value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query</span><span class="o">.</span><span class="n">set_variable_value</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">filter_value</span><span class="p">)</span>

        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attributes_for_type</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parsed_data</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">continuous_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">parsed_data</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">]:</span>
                <span class="n">access_groups</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;accessGroups&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">access_groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">user</span><span class="p">[</span><span class="s2">&quot;accessGroups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">access_groups</span><span class="p">)</span>
                <span class="n">all_attrib</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allAttrib&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_attrib</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">user</span><span class="p">[</span><span class="s2">&quot;allAttrib&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">all_attrib</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;attrib&quot;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">user</span><span class="p">[</span><span class="s2">&quot;ownAttrib&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;attrib&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">attrib</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;attrib&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">attr_def</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">attr_def</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_def</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">user</span></div>

<div class="viewcode-block" id="ServerAPI.get_user_by_name"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_user_by_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_by_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user by name using GraphQl.</span>

<span class="sd">        Only administrators and managers can fetch all users. For other users</span>
<span class="sd">            it is required to pass in &#39;project_name&#39; filter.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (str): Username.</span>
<span class="sd">            project_name (Optional[str]): Define scope of project.</span>
<span class="sd">            fields (Optional[Iterable[str]]): Fields to be queried</span>
<span class="sd">                for users.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[dict[str, Any], None]: User info or None if user is not</span>
<span class="sd">                found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_users</span><span class="p">(</span>
            <span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
            <span class="n">usernames</span><span class="o">=</span><span class="p">{</span><span class="n">username</span><span class="p">},</span>
            <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">user</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ServerAPI.get_user"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get user info using REST endpoint.</span>

<span class="sd">        User contains only explicitly set attributes in &#39;attrib&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (Optional[str]): Username.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[dict[str, Any]]: User info or None if user is not</span>
<span class="sd">                found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnauthorizedError</span><span class="p">(</span><span class="s2">&quot;User is not authorized.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;users/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># NOTE Server does return only filled attributes right now.</span>
        <span class="c1">#   This would fill all missing attributes with &#39;None&#39;.</span>
        <span class="c1"># for attr_name in self.get_attributes_for_type(&quot;user&quot;):</span>
        <span class="c1">#     user[&quot;attrib&quot;].setdefault(attr_name, None)</span>

        <span class="n">fill_own_attribs</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span></div>

<div class="viewcode-block" id="ServerAPI.get_headers"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_headers">[docs]</a>    <span class="k">def</span> <span class="nf">get_headers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;application/json&quot;</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
            <span class="s2">&quot;x-ayon-platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s2">&quot;x-ayon-hostname&quot;</span><span class="p">:</span> <span class="n">get_machine_name</span><span class="p">(),</span>
            <span class="s2">&quot;referer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_url</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-ayon-site-id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-ayon-version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client_version</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-sender-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-sender&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sender</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token_is_service</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Api-Key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span>
                <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_user_stack</span><span class="o">.</span><span class="n">username</span>
                <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
                    <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-as-user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">headers</span></div>

<div class="viewcode-block" id="ServerAPI.login"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.login">[docs]</a>    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">create_session</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Login to server.</span>

<span class="sd">        Args:</span>
<span class="sd">            username (str): Username.</span>
<span class="sd">            password (str): Password.</span>
<span class="sd">            create_session (Optional[bool]): Create session after login.</span>
<span class="sd">                Default: True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AuthenticationError: Login failed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_valid_token</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UnauthorizedError</span><span class="p">:</span>
                <span class="n">user_info</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">current_username</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_username</span> <span class="o">==</span> <span class="n">username</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_session</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">create_session</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create_session</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">validate_server_availability</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;auth/login&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">_detail</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">_detail</span><span class="p">:</span>
                    <span class="n">details</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">_detail</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Login failed </span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_valid_token</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s2">&quot;Invalid credentials&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_session</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.logout"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.logout">[docs]</a>    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">soft</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logout</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logout_from_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_token</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_rest_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_retries&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_retries</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Validate token if was not yet validated</span>
            <span class="c1">#    - ignore validation if we&#39;re in middle of</span>
            <span class="c1">#       validation</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_token_is_valid</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_validation_started</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validate_token</span><span class="p">()</span>

            <span class="k">if</span> <span class="s2">&quot;headers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">RequestType</span><span class="p">):</span>
                <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_functions_mapping</span><span class="p">[</span><span class="n">function</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">RequestType</span><span class="p">):</span>
            <span class="n">function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span><span class="p">[</span><span class="n">function</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">retry_idx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">except</span> <span class="ne">ConnectionRefusedError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">retry_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Connection error happened.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                <span class="c1"># Server may be restarting</span>
                <span class="n">new_response</span> <span class="o">=</span> <span class="n">RestApiResponse</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="s2">&quot;Unable to connect the server. Connection refused&quot;</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
                <span class="c1"># Connection timed out</span>
                <span class="n">new_response</span> <span class="o">=</span> <span class="n">RestApiResponse</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Connection timed out.&quot;</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
                <span class="c1"># Log warning only on last attempt</span>
                <span class="k">if</span> <span class="n">retry_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Connection error happened.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>

                <span class="n">new_response</span> <span class="o">=</span> <span class="n">RestApiResponse</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="s2">&quot;Unable to connect the server. Connection error&quot;</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_response</span>

        <span class="n">new_response</span> <span class="o">=</span> <span class="n">RestApiResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">new_response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_response</span>

<div class="viewcode-block" id="ServerAPI.raw_post"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.raw_post">[docs]</a>    <span class="k">def</span> <span class="nf">raw_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing [POST] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.raw_put"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.raw_put">[docs]</a>    <span class="k">def</span> <span class="nf">raw_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing [PUT] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">put</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.raw_patch"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.raw_patch">[docs]</a>    <span class="k">def</span> <span class="nf">raw_patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing [PATCH] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">patch</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.raw_get"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.raw_get">[docs]</a>    <span class="k">def</span> <span class="nf">raw_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing [GET] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.raw_delete"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.raw_delete">[docs]</a>    <span class="k">def</span> <span class="nf">raw_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing [DELETE] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.post"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_post</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.put"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_put</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.patch"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.patch">[docs]</a>    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_patch</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.get"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_get</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.delete"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_delete</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_endpoint_to_url</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">use_rest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cleanup endpoint and return full url to AYON server.</span>

<span class="sd">        If endpoint already starts with server url only slashes are removed.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint (str): Endpoint to be cleaned.</span>
<span class="sd">            use_rest (Optional[bool]): Use only base server url if set to</span>
<span class="sd">                False, otherwise REST endpoint is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Full url to AYON server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">endpoint</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rest_url</span> <span class="k">if</span> <span class="n">use_rest</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_download_file_to_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">TransferProgress</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">get_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_functions_mapping</span><span class="p">[</span><span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span><span class="p">[</span><span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">]</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_max_retries</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
            <span class="c1"># Continue in download</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_transferred_size</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;bytes=</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">-&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">get_func</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">progress</span><span class="o">.</span><span class="n">get_content_size</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">set_content_size</span><span class="p">(</span>
                            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-length&quot;</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>
                        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">add_transferred_chunk</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
                <span class="k">break</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">,</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">next_attempt</span><span class="p">()</span>

<div class="viewcode-block" id="ServerAPI.download_file_to_stream"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.download_file_to_stream">[docs]</a>    <span class="k">def</span> <span class="nf">download_file_to_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransferProgress</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download file from AYON server to IOStream.</span>

<span class="sd">        Endpoint can be full url (must start with &#39;base_url&#39; of api object).</span>

<span class="sd">        Progress object can be used to track download. Can be used when</span>
<span class="sd">        download happens in thread and other thread want to catch changes over</span>
<span class="sd">        time.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Use retries and timeout.</span>
<span class="sd">            Return RestApiResponse.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint (str): Endpoint or URL to file that should be downloaded.</span>
<span class="sd">            stream (StreamType): Stream where output will</span>
<span class="sd">                be stored.</span>
<span class="sd">            chunk_size (Optional[int]): Size of chunks that are received</span>
<span class="sd">                in single loop.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track download progress.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk_size</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_download_chunk_size</span>

        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">use_rest</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">TransferProgress</span><span class="p">()</span>

        <span class="n">progress</span><span class="o">.</span><span class="n">set_source_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">set_started</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_download_file_to_stream</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">progress</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_transfer_done</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">progress</span></div>

<div class="viewcode-block" id="ServerAPI.download_file"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.download_file">[docs]</a>    <span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransferProgress</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download file from AYON server.</span>

<span class="sd">        Endpoint can be full url (must start with &#39;base_url&#39; of api object).</span>

<span class="sd">        Progress object can be used to track download. Can be used when</span>
<span class="sd">        download happens in thread and other thread want to catch changes over</span>
<span class="sd">        time.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Use retries and timeout.</span>
<span class="sd">            Return RestApiResponse.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint (str): Endpoint or URL to file that should be downloaded.</span>
<span class="sd">            filepath (str): Path where file will be downloaded.</span>
<span class="sd">            chunk_size (Optional[int]): Size of chunks that are received</span>
<span class="sd">                in single loop.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track download progress.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create dummy object so the function does not have to check</span>
        <span class="c1">#   &#39;progress&#39; variable everywhere</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">TransferProgress</span><span class="p">()</span>

        <span class="n">progress</span><span class="o">.</span><span class="n">set_destination_url</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">dst_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_file_to_stream</span><span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">progress</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">progress</span></div>

<div class="viewcode-block" id="ServerAPI.download_project_file"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.download_project_file">[docs]</a>    <span class="k">def</span> <span class="nf">download_project_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransferProgress</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download project file to filepath.</span>

<span class="sd">        Project files are usually binary files, such as images, videos,</span>
<span class="sd">            or other media files that can be accessed via api endpoint</span>
<span class="sd">            &#39;{server url}/api/projects/{project_name}/files/{file_id}&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): Project name.</span>
<span class="sd">            file_id (str): File id.</span>
<span class="sd">            filepath (str): Path where file will be downloaded.</span>
<span class="sd">            chunk_size (Optional[int]): Size of chunks that are received</span>
<span class="sd">                in single loop.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track download progress.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransferProgress: Progress object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;api/projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/files/</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.download_project_file_to_stream"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.download_project_file_to_stream">[docs]</a>    <span class="k">def</span> <span class="nf">download_project_file_to_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">file_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransferProgress</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download project file to a stream.</span>

<span class="sd">        Project files are usually binary files, such as images, videos,</span>
<span class="sd">            or other media files that can be accessed via api endpoint</span>
<span class="sd">            &#39;{server url}/api/projects/{project_name}/files/{file_id}&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): Project name.</span>
<span class="sd">            file_id (str): File id.</span>
<span class="sd">            stream (StreamType): Stream where output will be stored.</span>
<span class="sd">            chunk_size (Optional[int]): Size of chunks that are received</span>
<span class="sd">                in single loop.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track download progress.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TransferProgress: Progress object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_file_to_stream</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;api/projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/files/</span><span class="si">{</span><span class="n">file_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">stream</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_upload_chunks_iter</span><span class="p">(</span>
        <span class="n">file_stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">TransferProgress</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generator that yields chunks of file.</span>

<span class="sd">        Args:</span>
<span class="sd">            file_stream (StreamType): Byte stream.</span>
<span class="sd">            progress (TransferProgress): Object to track upload progress.</span>
<span class="sd">            chunk_size (int): Size of chunks that are uploaded at once.</span>

<span class="sd">        Yields:</span>
<span class="sd">            bytes: Chunk of file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get size of file</span>
        <span class="n">file_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">file_stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">file_stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Set content size to progress object</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">set_content_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">file_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">add_transferred_chunk</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">def</span> <span class="nf">_upload_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">TransferProgress</span><span class="p">,</span>
        <span class="n">request_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload file to server.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): Url where file will be uploaded.</span>
<span class="sd">            stream (StreamType): File stream.</span>
<span class="sd">            progress (TransferProgress): Object that gives ability to track</span>
<span class="sd">                progress.</span>
<span class="sd">            request_type (Optional[RequestType]): Type of request that will</span>
<span class="sd">                be used. Default is PUT.</span>
<span class="sd">            chunk_size (Optional[int]): Size of chunks that are uploaded</span>
<span class="sd">                at once.</span>
<span class="sd">            **kwargs (Any): Additional arguments that will be passed</span>
<span class="sd">                to request function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response: Server response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">request_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request_type</span> <span class="o">=</span> <span class="n">RequestTypes</span><span class="o">.</span><span class="n">put</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                    <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">post_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_functions_mapping</span><span class="p">[</span><span class="n">request_type</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session_functions_mapping</span><span class="p">[</span><span class="n">request_type</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk_size</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_upload_chunk_size</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_max_retries</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">post_func</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_upload_chunks_iter</span><span class="p">(</span>
                        <span class="n">stream</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">chunk_size</span>
                    <span class="p">),</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">,</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">next_attempt</span><span class="p">()</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">reset_transferred</span><span class="p">()</span>

        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="ServerAPI.upload_file_from_stream"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.upload_file_from_stream">[docs]</a>    <span class="k">def</span> <span class="nf">upload_file_from_stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">StreamType</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">request_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload file to server from bytes.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Use retries and timeout.</span>
<span class="sd">            Return RestApiResponse.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint (str): Endpoint or url where file will be uploaded.</span>
<span class="sd">            stream (StreamType): File content stream.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track upload progress.</span>
<span class="sd">            request_type (Optional[RequestType]): Type of request that will</span>
<span class="sd">                be used to upload file.</span>
<span class="sd">            **kwargs (Any): Additional arguments that will be passed</span>
<span class="sd">                to request function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response: Response object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endpoint_to_url</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="c1"># Create dummy object so the function does not have to check</span>
        <span class="c1">#   &#39;progress&#39; variable everywhere</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">TransferProgress</span><span class="p">()</span>

        <span class="n">progress</span><span class="o">.</span><span class="n">set_destination_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">progress</span><span class="o">.</span><span class="n">set_started</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_file</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">set_transfer_done</span><span class="p">()</span></div>

<div class="viewcode-block" id="ServerAPI.upload_file"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.upload_file">[docs]</a>    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">request_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload file to server.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Use retries and timeout.</span>
<span class="sd">            Return RestApiResponse.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint (str): Endpoint or url where file will be uploaded.</span>
<span class="sd">            filepath (str): Source filepath.</span>
<span class="sd">            progress (Optional[TransferProgress]): Object that gives ability</span>
<span class="sd">                to track upload progress.</span>
<span class="sd">            request_type (Optional[RequestType]): Type of request that will</span>
<span class="sd">                be used to upload file.</span>
<span class="sd">            **kwargs (Any): Additional arguments that will be passed</span>
<span class="sd">                to request function.</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response: Response object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">TransferProgress</span><span class="p">()</span>

        <span class="n">progress</span><span class="o">.</span><span class="n">set_source_url</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file_from_stream</span><span class="p">(</span>
                <span class="n">endpoint</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.upload_reviewable"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.upload_reviewable">[docs]</a>    <span class="k">def</span> <span class="nf">upload_reviewable</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">version_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransferProgress</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Upload reviewable file to server.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): Project name.</span>
<span class="sd">            version_id (str): Version id.</span>
<span class="sd">            filepath (str): Reviewable file path to upload.</span>
<span class="sd">            label (Optional[str]): Reviewable label. Filled automatically</span>
<span class="sd">                server side with filename.</span>
<span class="sd">            content_type (Optional[str]): MIME type of the file.</span>
<span class="sd">            filename (Optional[str]): User as original filename. Filename from</span>
<span class="sd">                &#39;filepath&#39; is used when not filled.</span>
<span class="sd">            progress (Optional[TransferProgress]): Progress.</span>
<span class="sd">            headers (Optional[dict[str, Any]]): Headers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            requests.Response: Server response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">get_media_mime_type</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not determine MIME type of file &#39;</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make sure content-type is filled with file content type</span>
            <span class="n">content_type_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">key</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;content-type&quot;</span>
                <span class="p">),</span>
                <span class="s2">&quot;Content-Type&quot;</span>
            <span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">content_type_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>

        <span class="c1"># Fill original filename if not explicitly defined</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-file-name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">prepare_query_string</span><span class="p">({</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">})</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;/projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;/versions/</span><span class="si">{</span><span class="n">version_id</span><span class="si">}</span><span class="s2">/reviewables</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span>
            <span class="n">endpoint</span><span class="p">,</span>
            <span class="n">filepath</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">request_type</span><span class="o">=</span><span class="n">RequestTypes</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.trigger_server_restart"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.trigger_server_restart">[docs]</a>    <span class="k">def</span> <span class="nf">trigger_server_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger server restart.</span>

<span class="sd">        Restart may be required when a change of specific value happened on</span>
<span class="sd">        server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;system/restart&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">204</span><span class="p">:</span>
            <span class="c1"># TODO add better exception</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Failed to restart server&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.query_graphql"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.query_graphql">[docs]</a>    <span class="k">def</span> <span class="nf">query_graphql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphQlResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute GraphQl query.</span>

<span class="sd">        Args:</span>
<span class="sd">            query (str): GraphQl query string.</span>
<span class="sd">            variables (Optional[dict[str, Any]): Variables that can be</span>
<span class="sd">                used in query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            GraphQlResponse: Response from server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s2">&quot;variables&quot;</span><span class="p">:</span> <span class="n">variables</span> <span class="ow">or</span> <span class="p">{}}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span>
            <span class="n">RequestTypes</span><span class="o">.</span><span class="n">post</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_graphql_url</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">data</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">GraphQlResponse</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.get_graphql_schema"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_graphql_schema">[docs]</a>    <span class="k">def</span> <span class="nf">get_graphql_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_graphql</span><span class="p">(</span><span class="n">INTROSPECTION_QUERY</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ServerAPI.get_server_schema"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_server_schema">[docs]</a>    <span class="k">def</span> <span class="nf">get_server_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get server schema with info, url paths, components etc.</span>

<span class="sd">        Todos:</span>
<span class="sd">            Cache schema - How to find out it is outdated?</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: Full server schema.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">/openapi.json&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_rest_request</span><span class="p">(</span><span class="n">RequestTypes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ServerAPI.get_schemas"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_schemas">[docs]</a>    <span class="k">def</span> <span class="nf">get_schemas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get components schema.</span>

<span class="sd">        Name of components does not match entity type names e.g. &#39;project&#39; is</span>
<span class="sd">        under &#39;ProjectModel&#39;. We should find out some mapping. Also, there</span>
<span class="sd">        are properties which don&#39;t have information about reference to object</span>
<span class="sd">        e.g. &#39;config&#39; has just object definition without reference schema.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: Component schemas.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">server_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_server_schema</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">server_schema</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">][</span><span class="s2">&quot;schemas&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ServerAPI.get_default_fields_for_type"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_default_fields_for_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_fields_for_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default fields for entity type.</span>

<span class="sd">        Returns most of commonly used fields from server.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity_type (str): Name of entity type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            set[str]: Fields that should be queried from server.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Event does not have attributes</span>
        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_EVENT_FIELDS</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;activity&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_ACTIVITY_FIELDS</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_PROJECT_FIELDS</span><span class="p">)</span>
            <span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">entity_type_defaults</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;productTypes&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;folder&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_FOLDER_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_TASK_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;product&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_PRODUCT_FIELDS</span><span class="p">)</span>
            <span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_product_base_type_supported</span><span class="p">():</span>
                <span class="n">entity_type_defaults</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;productBaseType&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_VERSION_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;representation&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">DEFAULT_REPRESENTATION_FIELDS</span>
                <span class="o">|</span> <span class="n">REPRESENTATION_FILES_FIELDS</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">graphql_allows_traits_in_representations</span><span class="p">:</span>
                <span class="n">entity_type_defaults</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="s2">&quot;traits&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;productType&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_PRODUCT_TYPE_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;workfile&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_WORKFILE_INFO_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_USER_FIELDS</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="s2">&quot;entityList&quot;</span><span class="p">:</span>
            <span class="n">entity_type_defaults</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_ENTITY_LIST_FIELDS</span><span class="p">)</span>
            <span class="c1"># Attributes scope is &#39;list&#39;</span>
            <span class="n">entity_type</span> <span class="o">=</span> <span class="s2">&quot;list&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown entity type </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">entity_type_defaults</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attributes_fields_for_type</span><span class="p">(</span><span class="n">entity_type</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.get_rest_entity_by_id"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_rest_entity_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_rest_entity_by_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">entity_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnyEntityDict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get entity using REST on a project by its id.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): Name of project where entity is.</span>
<span class="sd">            entity_type (Literal[&quot;folder&quot;, &quot;task&quot;, &quot;product&quot;, &quot;version&quot;]): The</span>
<span class="sd">                entity type which should be received.</span>
<span class="sd">            entity_id (str): Id of entity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[AnyEntityDict]: Received entity data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">project_name</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span><span class="s2">s/</span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># --- Batch operations processing ---</span>
<div class="viewcode-block" id="ServerAPI.send_batch_operations"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.send_batch_operations">[docs]</a>    <span class="k">def</span> <span class="nf">send_batch_operations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">can_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_on_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post multiple CRUD operations to server.</span>

<span class="sd">        When multiple changes should be made on server side this is the best</span>
<span class="sd">        way to go. It is possible to pass multiple operations to process on a</span>
<span class="sd">        server side and do the changes in a transaction.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): On which project should be operations</span>
<span class="sd">                processed.</span>
<span class="sd">            operations (list[dict[str, Any]]): Operations to be processed.</span>
<span class="sd">            can_fail (Optional[bool]): Server will try to process all</span>
<span class="sd">                operations even if one of them fails.</span>
<span class="sd">            raise_on_fail (Optional[bool]): Raise exception if an operation</span>
<span class="sd">                fails. You can handle failed operations on your own</span>
<span class="sd">                when set to &#39;False&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Operations can&#39;t be converted to json string.</span>
<span class="sd">            FailedOperations: When output does not contain server operations</span>
<span class="sd">                or &#39;raise_on_fail&#39; is enabled and any operation fails.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict[str, Any]]: Operations result with process details.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_batch_operations</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/operations&quot;</span><span class="p">,</span>
            <span class="n">operations</span><span class="p">,</span>
            <span class="n">can_fail</span><span class="p">,</span>
            <span class="n">raise_on_fail</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ServerAPI.send_background_batch_operations"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.send_background_batch_operations">[docs]</a>    <span class="k">def</span> <span class="nf">send_background_batch_operations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">can_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_on_fail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackgroundOperationTask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post multiple CRUD operations to server.</span>

<span class="sd">        When multiple changes should be made on server side this is the best</span>
<span class="sd">        way to go. It is possible to pass multiple operations to process on a</span>
<span class="sd">        server side and do the changes in a transaction.</span>

<span class="sd">        Compared to &#39;send_batch_operations&#39; this function creates a task on</span>
<span class="sd">            server which then can be periodically checked for a status and</span>
<span class="sd">            receive it&#39;s result.</span>

<span class="sd">        When used with &#39;wait&#39; set to &#39;True&#39; this method blocks until task is</span>
<span class="sd">            finished. Which makes it work as &#39;send_batch_operations&#39;</span>
<span class="sd">            but safer for large operations batch as is not bound to</span>
<span class="sd">            response timeout.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): On which project should be operations</span>
<span class="sd">                processed.</span>
<span class="sd">            operations (list[dict[str, Any]]): Operations to be processed.</span>
<span class="sd">            can_fail (Optional[bool]): Server will try to process all</span>
<span class="sd">                operations even if one of them fails.</span>
<span class="sd">            wait (bool): Wait for operations to end.</span>
<span class="sd">            raise_on_fail (Optional[bool]): Raise exception if an operation</span>
<span class="sd">                fails. You can handle failed operations on your own</span>
<span class="sd">                when set to &#39;False&#39;. Used when &#39;wait&#39; is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Operations can&#39;t be converted to json string.</span>
<span class="sd">            FailedOperations: When output does not contain server operations</span>
<span class="sd">                or &#39;raise_on_fail&#39; is enabled and any operation fails.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BackgroundOperationTask: Background operation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operations_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_operations_body</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/operations/background&quot;</span><span class="p">,</span>
            <span class="n">operations</span><span class="o">=</span><span class="n">operations_body</span><span class="p">,</span>
            <span class="n">canFail</span><span class="o">=</span><span class="n">can_fail</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wait</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

        <span class="n">task_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">op_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_background_operations_status</span><span class="p">(</span>
                <span class="n">project_name</span><span class="p">,</span> <span class="n">task_id</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">op_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">raise_on_fail</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_operations_result</span><span class="p">(</span>
                <span class="n">op_status</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span> <span class="n">operations_body</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">op_status</span></div>

<div class="viewcode-block" id="ServerAPI.get_background_operations_status"><a class="viewcode-back" href="../../ayon_api.server_api.html#ayon_api.ServerAPI.get_background_operations_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_background_operations_status</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackgroundOperationTask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get status of background operations task.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_name (str): Project name.</span>
<span class="sd">            task_id (str): Backgorund operation task id.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BackgroundOperationTask: Background operation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;projects/</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">/operations/background/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">_prepare_operations_body</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">operations_body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">operation</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">op_id</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">op_id</span><span class="p">:</span>
                <span class="n">op_id</span> <span class="o">=</span> <span class="n">create_entity_id</span><span class="p">()</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_id</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">entity_data_json_default</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t json parse body: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="n">operation</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">failed_json_default</span>
                    <span class="p">)</span>
                <span class="p">))</span>

            <span class="n">operations_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">operations_body</span>

    <span class="k">def</span> <span class="nf">_send_batch_operations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">operations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">can_fail</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">raise_on_fail</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operations</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">operations_body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_operations_body</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">operations_body</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">uri</span><span class="p">,</span>
            <span class="n">operations</span><span class="o">=</span><span class="n">operations_body</span><span class="p">,</span>
            <span class="n">canFail</span><span class="o">=</span><span class="n">can_fail</span>
        <span class="p">)</span>

        <span class="n">op_results</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FailedOperations</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed. Detail: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">FailedOperations</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Operation failed. Content: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">raise_on_fail</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_operations_result</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">operations_body</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">op_results</span>

    <span class="k">def</span> <span class="nf">_validate_operations_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">operations_body</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op_result</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">op_result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">operation_id</span> <span class="o">=</span> <span class="n">op_result</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">op</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operations_body</span>
                <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">operation_id</span>
            <span class="p">)</span>
            <span class="n">detail</span> <span class="o">=</span> <span class="n">op_result</span><span class="p">[</span><span class="s2">&quot;detail&quot;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">FailedOperations</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Operation </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">operation_id</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> failed with data:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detail: </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_fields</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">own_attributes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;attrib&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;attrib&quot;</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attributes_fields_for_type</span><span class="p">(</span><span class="n">entity_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">own_attributes</span> <span class="ow">and</span> <span class="n">entity_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="s2">&quot;folder&quot;</span><span class="p">,</span> <span class="s2">&quot;task&quot;</span><span class="p">}:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;ownAttrib&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">!=</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Use &#39;data&#39; to fill &#39;bundle&#39; data</span>
        <span class="k">if</span> <span class="s2">&quot;bundle&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;bundle&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_version_tuple</span>
        <span class="k">if</span> <span class="s2">&quot;folderTypes&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;folderTypes&quot;</span><span class="p">)</span>
            <span class="n">folder_types_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_FOLDER_TYPE_FIELDS</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">folder_types_fields</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;shortName&quot;</span><span class="p">}</span>
            <span class="n">fields</span> <span class="o">|=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;folderTypes.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">folder_types_fields</span><span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;taskTypes&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;taskTypes&quot;</span><span class="p">)</span>
            <span class="n">task_types_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">DEFAULT_TASK_TYPE_FIELDS</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">task_types_fields</span> <span class="o">|=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">,</span> <span class="s2">&quot;shortName&quot;</span><span class="p">}</span>
            <span class="n">fields</span> <span class="o">|=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;taskTypes.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">task_types_fields</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">default_fields</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;statuses&quot;</span><span class="p">,</span> <span class="n">DEFAULT_PROJECT_STATUSES_FIELDS</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">DEFAULT_PROJECT_TAGS_FIELDS</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;linkTypes&quot;</span><span class="p">,</span> <span class="n">DEFAULT_PROJECT_TAGS_FIELDS</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maj_v</span><span class="p">,</span> <span class="n">min_v</span><span class="p">,</span> <span class="n">patch_v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">fields</span> <span class="o">|=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">default_fields</span><span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;productTypes&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;productTypes&quot;</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;productTypes.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_fields_for_type</span><span class="p">(</span>
                    <span class="s2">&quot;productType&quot;</span>
                <span class="p">)</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_prepare_advanced_filters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filters</span>

    <span class="k">def</span> <span class="nf">_convert_entity_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">AnyEntityDict</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span> <span class="ow">or</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">entity_data</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">entity_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">entity_data</span><span class="p">)</span>

        <span class="n">entity</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity_data</span></div>
</pre></div>

					 </div>
					 
					</div>
					<footer>
  

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2024, ynput.io <info@ynput.io>
	  <br>
      
      
      
      Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
      
      <a href="https://github.com/revitron/revitron-sphinx-theme">theme</a>
      
      provided by <a href="https://github.com/revitron">Revitron</a>.

    </p>
  </div> 

</footer>

				</div>
			</div>

		</section>

	</div>
	

	<script type="text/javascript">
			jQuery(function () {
					SphinxRtdTheme.Navigation.enable(true);
			});
	</script>

	
	
		
	 

 
</body>	
</html>